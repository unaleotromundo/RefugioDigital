<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archivo de Reflexiones | Panel de Estudio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .chat-scroll { max-height: calc(100vh - 200px); overflow-y: auto; }
        .user-bubble { background: #fef3c7; border: 1px solid #fde68a; }
        .ai-bubble { background: #ffffff; border: 1px solid #e2e8f0; font-style: italic; }
        .selected-item { border-left: 4px solid #d97706 !important; background: #fffbeb; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- ENCABEZADO -->
    <header class="bg-white border-b border-slate-200 p-4 flex justify-between items-center shadow-sm">
        <div>
            <h1 class="text-xl font-extrabold text-slate-800 uppercase tracking-tighter">Archivo del Espejo</h1>
            <p class="text-xs text-slate-500 font-bold uppercase tracking-widest">Panel de an√°lisis y estudio</p>
        </div>
        <div class="flex gap-4">
            <button onclick="fetchChats()" class="bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-amber-700 transition">
                üîÑ Actualizar
            </button>
            <a href="index.html" class="text-slate-500 hover:text-slate-800 self-center text-sm font-bold">‚Üê Volver al Chat</a>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <!-- BARRA LATERAL: LISTA DE CONVERSACIONES -->
        <aside class="w-1/3 border-r border-slate-200 bg-white flex flex-col">
            <div class="p-4 border-b border-slate-100">
                <input type="text" id="search" placeholder="Buscar por contenido..." 
                       class="w-full p-2 bg-slate-100 border-none rounded-md text-sm"
                       oninput="filterChats()">
            </div>
            <div id="chats-list" class="flex-1 overflow-y-auto">
                <div class="p-8 text-center text-slate-400">Cargando archivo...</div>
            </div>
        </aside>

        <!-- AREA PRINCIPAL: VISOR DE CONVERSACI√ìN -->
        <main class="flex-1 bg-slate-50 flex flex-col">
            <div id="chat-header" class="p-6 bg-white border-b border-slate-200 hidden">
                <h2 id="view-title" class="text-lg font-bold text-slate-800"></h2>
                <div class="flex gap-4 mt-1">
                    <span id="view-date" class="text-xs font-bold text-amber-600 uppercase"></span>
                    <span id="view-id" class="text-xs font-bold text-slate-400 uppercase"></span>
                </div>
            </div>

            <div id="chat-content" class="chat-scroll p-6 space-y-4">
                <div class="h-full flex items-center justify-center text-slate-400 italic">
                    Selecciona una conversaci√≥n de la izquierda para analizarla
                </div>
            </div>
        </main>
    </div>

    <!-- SCRIPT DE L√ìGICA -->
    <script src="config.js"></script>
    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        let allChats = [];

        async function fetchChats() {
            const listContainer = document.getElementById('chats-list');
            
            try {
                // Obtenemos todos los chats ordenados por fecha
                const { data, error } = await supabaseClient
                    .from('chats')
                    .select('*')
                    .order('updated_at', { ascending: false });

                if (error) throw error;
                allChats = data;
                renderList(allChats);

            } catch (err) {
                listContainer.innerHTML = `<div class="p-8 text-red-500">Error: ${err.message}</div>`;
            }
        }

        function renderList(chats) {
            const listContainer = document.getElementById('chats-list');
            if (chats.length === 0) {
                listContainer.innerHTML = `<div class="p-8 text-center text-slate-400">No hay conversaciones guardadas.</div>`;
                return;
            }

            listContainer.innerHTML = chats.map(chat => `
                <div onclick="displayChat('${chat.id}')" 
                     id="item-${chat.id}"
                     class="p-4 border-b border-slate-100 cursor-pointer hover:bg-slate-50 transition-all border-left-4 border-transparent">
                    <div class="text-sm font-bold text-slate-800 truncate">${chat.title || 'Sin t√≠tulo'}</div>
                    <div class="flex justify-between mt-1">
                        <span class="text-[10px] font-black text-amber-600 uppercase">${new Date(chat.updated_at).toLocaleDateString()}</span>
                        <span class="text-[10px] font-bold text-slate-400 uppercase">ID: ${chat.user_id.substring(0,8)}</span>
                    </div>
                </div>
            `).join('');
        }

        function displayChat(id) {
            const chat = allChats.find(c => c.id == id);
            if (!chat) return;

            // UI de selecci√≥n
            document.querySelectorAll('#chats-list > div').forEach(el => el.classList.remove('selected-item'));
            document.getElementById(`item-${id}`).classList.add('selected-item');

            // Cabecera
            document.getElementById('chat-header').classList.remove('hidden');
            document.getElementById('view-title').innerText = chat.title;
            document.getElementById('view-date').innerText = new Date(chat.updated_at).toLocaleString();
            document.getElementById('view-id').innerText = `Usuario Ref: ${chat.user_id}`;

            // Contenido
            const content = document.getElementById('chat-content');
            const history = chat.history || [];

            content.innerHTML = history.map(msg => {
                const isUser = msg.role === 'user';
                return `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[80%] p-4 rounded-2xl shadow-sm ${isUser ? 'user-bubble' : 'ai-bubble'}">
                            <div class="text-[9px] uppercase font-black mb-1 opacity-50">${isUser ? 'Pregunta' : 'Espejo'}</div>
                            <div class="text-slate-800 leading-relaxed">${msg.parts[0].text.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterChats() {
            const term = document.getElementById('search').value.toLowerCase();
            const filtered = allChats.filter(chat => 
                chat.title.toLowerCase().includes(term) || 
                JSON.stringify(chat.history).toLowerCase().includes(term)
            );
            renderList(filtered);
        }

        // Cargar al iniciar
        fetchChats();
    </script>
</body>
</html>