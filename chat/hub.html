<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Hub de Conciencias | Espejo Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link rel="stylesheet" href="style.css"> 
</head>
<body class="transition-colors duration-500 overflow-hidden h-screen">
    <div id="particle-container"></div>

    <!-- SIDEBAR: HISTORIAL -->
    <div id="history-sidebar" class="fixed top-0 left-0 h-full w-80 bg-white dark:bg-slate-900 z-50 transform -translate-x-full transition-transform duration-300 border-r-2 border-black shadow-2xl">
        <div class="p-6 flex flex-col h-full">
            <h2 class="text-black dark:text-white font-black uppercase mb-8">Mis Reflexiones</h2>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3"></div>
            <button onclick="createNewChat()" class="mt-4 w-full py-3 bg-black text-white rounded-xl font-bold"> + NUEVA SESIÃ“N </button>
            <button onclick="toggleSidebar('history-sidebar', false)" class="mt-2 text-xs uppercase font-bold">Cerrar</button>
        </div>
    </div>

    <!-- SIDEBAR: CONCIENCIAS -->
    <div id="agents-sidebar" class="fixed top-0 right-0 h-full w-80 bg-slate-950 z-50 transform translate-x-full transition-transform duration-300 border-l-2 border-amber-500 shadow-2xl">
        <div class="p-6 flex flex-col h-full">
            <h2 class="text-amber-500 font-black uppercase mb-6">Conciencias</h2>
            <button onclick="checkAdminPassword()" class="mb-6 w-full py-3 border-2 border-dashed border-amber-500/50 text-amber-500 font-bold text-xs uppercase tracking-widest"> + CREAR CONCIENCIA </button>
            <div id="agents-list" class="flex-1 overflow-y-auto space-y-3"></div>
            <button onclick="toggleSidebar('agents-sidebar', false)" class="mt-4 text-amber-500 text-xs font-bold uppercase">Cerrar</button>
        </div>
    </div>

    <nav class="p-6 flex justify-between items-center max-w-7xl mx-auto w-full relative z-20">
        <button onclick="toggleSidebar('history-sidebar', true)" class="p-3 rounded-full text-xl">âŒ›</button>
        <div class="flex items-center gap-3">
            <button onclick="toggleDarkMode()" class="p-3 rounded-full text-xl">ðŸŒ™</button>
            <button onclick="toggleSidebar('agents-sidebar', true)" class="p-3 rounded-full text-xl bg-amber-500">âœ¨</button>
        </div>
    </nav>

    <main class="relative z-10 flex flex-col h-[calc(100vh-140px)] max-w-4xl mx-auto px-4 w-full">
        <div class="text-center mb-6">
            <h1 id="active-agent-name">Cargando...</h1>
            <p id="active-agent-desc" class="text-black dark:text-amber-500 font-bold text-[10px] uppercase tracking-widest">Selecciona una conciencia</p>
        </div>

        <div class="chat-frame flex flex-col">
            <div id="chat-box" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4"></div>
        </div>

        <div class="mt-6 relative w-full mb-4 z-20">
            <div id="image-preview-container" class="hidden absolute bottom-full mb-3 left-0 p-2 bg-white border-2 border-black rounded-xl shadow-lg flex items-center gap-2">
                <img id="image-preview" src="" class="h-16 w-16 object-cover rounded-lg">
                <button onclick="clearImage()" class="bg-red-500 text-white rounded-full p-1 text-xs">âœ•</button>
            </div>

            <div class="flex gap-2">
                <div class="relative flex-1">
                    <input type="text" id="chat-input" placeholder="Dime o sube una imagen..." 
                           class="w-full p-5 pr-16 rounded-2xl border-2 border-black focus:border-amber-500 outline-none dark:bg-slate-900 dark:text-white">
                    <label for="image-upload" class="absolute right-4 top-1/2 -translate-y-1/2 cursor-pointer text-2xl">
                        ðŸ“Ž <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                    </label>
                </div>
                <button id="send-btn" onclick="handleSend()" class="p-5 rounded-2xl text-white bg-amber-600">âž¤</button>
            </div>
        </div>
    </main>

    <script src="config.js"></script>
    <script>
        const chatBox = document.getElementById('chat-box');
        const chatInput = document.getElementById('chat-input');
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

        let currentAgent = null;
        let currentChatId = null;
        let chatHistory = []; 
        let currentUser = null;
        let selectedImageBase64 = null;

        async function init() {
            const { data } = await supabaseClient.auth.signInAnonymously();
            currentUser = data.user;
            await cargarAgentes();
            await refreshHistorySidebar();
            setInterval(createParticle, 600);
            chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSend(); });
        }

        function checkAdminPassword() {
            if (prompt("ContraseÃ±a:") === "admin123") window.location.href = "configurador.html";
            else alert("Error.");
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImageBase64 = e.target.result.split(',')[1];
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('image-preview-container').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            selectedImageBase64 = null;
            document.getElementById('image-upload').value = '';
            document.getElementById('image-preview-container').classList.add('hidden');
        }

        async function cargarAgentes() {
            const { data } = await supabaseClient.from('agentes').select('*').order('created_at', { ascending: false });
            const list = document.getElementById('agents-list');
            list.innerHTML = '';
            data.forEach((agente, i) => {
                const div = document.createElement('div');
                div.id = `agent-${agente.id}`;
                div.className = "agent-card p-4 rounded-2xl cursor-pointer transition-all";
                div.onclick = () => setAgent(agente);
                div.innerHTML = `<div class="font-bold text-sm">âœ¨ ${agente.nombre}</div><div class="text-[10px] opacity-60 uppercase">${agente.descripcion || 'Conciencia'}</div>`;
                list.appendChild(div);
                if (i === 0) setAgent(agente);
            });
        }

        async function setAgent(agente) {
            currentAgent = agente;
            currentAgent.conocimiento_texto = ""; 
            if (agente.archivo_url) {
                try {
                    const res = await fetch(agente.archivo_url);
                    const blob = await res.blob();
                    const ext = agente.archivo_url.split('.').pop().toLowerCase().split('?')[0];
                    if (ext === 'txt' || ext === 'json') currentAgent.conocimiento_texto = await blob.text();
                    else if (ext === 'pdf') currentAgent.conocimiento_texto = await extractTextFromPDF(agente.archivo_url);
                } catch(e) {}
            }
            document.getElementById('active-agent-name').innerText = currentAgent.nombre;
            document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`agent-${agente.id}`)?.classList.add('active');
            toggleSidebar('agents-sidebar', false);
            createNewChat();
        }

        async function handleSend() {
            const text = chatInput.value.trim();
            if (!text && !selectedImageBase64) return;

            let uiText = text;
            if (selectedImageBase64) {
                const src = document.getElementById('image-preview').src;
                uiText = `<div class="flex flex-col gap-2"><img src="${src}" class="max-w-[200px] rounded-lg border-2 border-white"><span>${text}</span></div>`;
            }

            renderBubbleUI(uiText, true);
            const typing = showTyping();
            const imgData = selectedImageBase64;
            const msgText = text;

            chatInput.value = '';
            clearImage();

            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        systemInstruction: `${currentAgent.instrucciones}\n\nCONTEXTO:\n${currentAgent.conocimiento_texto || ''}`, 
                        contents: chatHistory,
                        image: imgData,
                        text: msgText
                    })
                });

                const data = await response.json();
                typing.remove();
                if (data.success) {
                    chatHistory.push({ role: "user", parts: [{ text: msgText || "[Imagen]" }] });
                    chatHistory.push({ role: "model", parts: [{ text: data.text }] });
                    renderBubbleUI(data.text, false);
                    await saveToHubHistory();
                }
            } catch (err) {
                typing.remove();
                renderBubbleUI("Error de conexiÃ³n.", false);
            }
        }

        function renderBubbleUI(text, isUser) {
            const div = document.createElement('div');
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `<div class="bubble ${isUser ? 'bubble-user' : 'bubble-ai'}">${text.replace(/\n/g, '<br>')}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function saveToHubHistory() {
            if (!currentUser || chatHistory.length < 2) return;
            const f = chatHistory.find(m => m.role === "user")?.parts[0].text || "ReflexiÃ³n";
            await supabaseClient.from('reflexiones_hub').upsert({
                id: currentChatId, user_id: currentUser.id, agent_id: currentAgent.id, title: f.substring(0,30)+"...", history: chatHistory, updated_at: new Date().toISOString()
            });
            refreshHistorySidebar();
        }

        async function refreshHistorySidebar() {
            if (!currentUser) return;
            const { data } = await supabaseClient.from('reflexiones_hub').select('*').eq('user_id', currentUser.id).order('updated_at', { ascending: false });
            document.getElementById('history-list').innerHTML = data.map(c => `
                <div onclick="loadChat('${c.id}')" class="p-3 border border-black rounded-lg cursor-pointer bg-slate-50 dark:bg-slate-800">
                    <div class="text-xs font-bold truncate">${c.title}</div>
                </div>
            `).join('');
        }

        async function loadChat(id) {
            const { data } = await supabaseClient.from('reflexiones_hub').select('*').eq('id', id).single();
            if(data) {
                currentChatId = data.id; chatHistory = data.history; chatBox.innerHTML = '';
                chatHistory.forEach(m => renderBubbleUI(m.parts[0].text, m.role === 'user'));
                toggleSidebar('history-sidebar', false);
            }
        }

        function createNewChat() {
            currentChatId = Date.now(); chatHistory = []; chatBox.innerHTML = '';
            if(currentAgent) renderBubbleUI(`Soy ${currentAgent.nombre}. Â¿QuÃ© buscas reflejar?`, false);
        }

        function toggleSidebar(id, show) {
            const el = document.getElementById(id);
            el.style.transform = show ? 'translateX(0)' : (id==='history-sidebar' ? 'translateX(-100%)' : 'translateX(100%)');
        }

        function showTyping() {
            const div = document.createElement('div');
            div.className = "text-xs italic opacity-50 p-2 dark:text-white";
            div.innerText = "Analizando...";
            chatBox.appendChild(div);
            return div;
        }

        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }

        function createParticle() {
            const container = document.getElementById('particle-container');
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = `${Math.random() * 100}%`;
            p.style.width = p.style.height = `${Math.random() * 4 + 2}px`;
            p.style.top = "-10px";
            container.appendChild(p);
            p.animate([{ top: "-10px", opacity: 0 }, { top: "100vh", opacity: 0.5 }], { duration: Math.random() * 5000 + 5000 });
            setTimeout(() => p.remove(), 10000);
        }

        init();
    </script>
</body>
</html>