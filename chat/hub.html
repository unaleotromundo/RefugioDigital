<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Hub de Conciencias | Espejo Digital</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <link rel="stylesheet" href="style.css"> 
</head>
<body class="bg-slate-50 dark:bg-slate-950 transition-colors duration-500 overflow-hidden h-screen">
    
    <div id="particle-container"></div>

    <!-- SIDEBAR: HISTORIAL -->
    <div id="history-sidebar" class="fixed top-0 left-0 h-full w-80 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl z-50 transform -translate-x-full transition-transform duration-300 border-r border-amber-500/20 shadow-2xl">
        <div class="p-6 flex flex-col h-full">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-amber-600 font-black uppercase tracking-widest text-sm">Mis Reflexiones</h2>
                <button onclick="toggleSidebar('history-sidebar', false)" class="text-slate-400 hover:text-amber-600 text-3xl">&times;</button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3"></div>
            <button onclick="createNewChat()" class="mt-4 w-full py-3 bg-amber-600 text-white rounded-xl font-bold uppercase text-[10px] tracking-widest">
                + Nueva Sesi√≥n
            </button>
        </div>
    </div>

    <!-- SIDEBAR: CONCIENCIAS -->
    <div id="agents-sidebar" class="fixed top-0 right-0 h-full w-80 bg-slate-900/95 backdrop-blur-xl z-50 transform translate-x-full transition-transform duration-300 border-l border-amber-500/20 shadow-2xl">
        <div class="p-6 flex flex-col h-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-amber-500 font-black uppercase tracking-widest text-sm">Conciencias</h2>
                <button onclick="toggleSidebar('agents-sidebar', false)" class="text-slate-400 hover:text-amber-500 text-3xl">&times;</button>
            </div>
            <button onclick="checkAdminPassword()" class="mb-6 w-full block text-center py-3 rounded-xl border-2 border-dashed border-amber-500/50 text-amber-500 font-bold text-[10px] uppercase tracking-widest hover:bg-amber-500/20 transition-all">
                + Crear Nueva Conciencia
            </button>
            <div id="agents-list" class="flex-1 overflow-y-auto space-y-3 pr-2"></div>
        </div>
    </div>

    <!-- NAV -->
    <nav class="p-6 flex justify-between items-center max-w-7xl mx-auto w-full relative z-20">
        <button onclick="toggleSidebar('history-sidebar', true)" class="p-3 rounded-full bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-y-1 hover:shadow-none transition-all text-xl">‚åõ</button>
        <div class="flex items-center gap-3">
            <button onclick="toggleDarkMode()" class="p-3 rounded-full bg-white border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-y-1 hover:shadow-none transition-all text-xl">üåô</button>
            <button onclick="toggleSidebar('agents-sidebar', true)" class="p-3 rounded-full bg-amber-500 border-2 border-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:translate-y-1 hover:shadow-none transition-all text-xl">‚ú®</button>
        </div>
    </nav>

    <main class="relative z-10 flex flex-col h-[calc(100vh-140px)] max-w-4xl mx-auto px-4 w-full">
        <div class="text-center mb-6">
            <h1 id="active-agent-name" class="text-4xl font-black uppercase tracking-tighter">Cargando...</h1>
            <p id="active-agent-desc" class="text-[10px] uppercase tracking-[0.4em] font-bold">Selecciona una conciencia</p>
        </div>

        <div class="chat-frame flex-1 overflow-hidden flex flex-col shadow-2xl">
            <div id="chat-box" class="chat-container flex-1 overflow-y-auto p-6 space-y-4"></div>
        </div>

        <!-- INPUT CON PREVIEW DE IMAGEN -->
        <div class="mt-6 relative w-full mb-4">
            <div id="image-preview-container" class="hidden absolute bottom-full mb-3 left-0 p-2 bg-white dark:bg-slate-800 rounded-xl border-2 border-black shadow-lg flex items-center gap-2">
                <img id="image-preview" src="" class="h-16 w-16 object-cover rounded-lg border border-slate-300">
                <button onclick="clearImage()" class="bg-red-500 text-white rounded-full p-1 hover:bg-red-600 text-xs">‚úï</button>
            </div>

            <div class="flex gap-2">
                <div class="relative flex-1">
                    <input type="text" id="chat-input" placeholder="Dime lo que piensas o sube una imagen..." 
                           class="w-full p-5 pr-16 rounded-2xl text-lg italic shadow-xl border-2 border-transparent focus:border-amber-500 outline-none dark:bg-slate-900 dark:text-white">
                    <label for="image-upload" class="absolute right-4 top-1/2 -translate-y-1/2 cursor-pointer hover:scale-110 transition-transform text-2xl">
                        üìé
                        <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                    </label>
                </div>
                <button id="send-btn" onclick="handleSend()" class="bg-amber-600 text-white p-5 rounded-2xl hover:bg-amber-700 shadow-lg font-bold">‚û§</button>
            </div>
        </div>
    </main>

    <script src="config.js"></script>
    <script>
        const chatBox = document.getElementById('chat-box');
        const chatInput = document.getElementById('chat-input');
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

        let currentAgent = null;
        let currentChatId = null;
        let chatHistory = []; 
        let currentUser = null;
        let selectedImageBase64 = null;

        async function init() {
            const { data: authData } = await supabaseClient.auth.signInAnonymously();
            currentUser = authData.user;
            await cargarAgentes();
            await refreshHistorySidebar();
            setInterval(createParticle, 600);
            chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSend(); });
        }

        // --- SEGURIDAD Y ADMIN ---
        function checkAdminPassword() {
            const pw = prompt("Contrase√±a de administrador:");
            if (pw === "admin123") window.location.href = "configurador.html";
            else alert("Acceso denegado.");
        }

        // --- MANEJO DE IM√ÅGENES ---
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImageBase64 = e.target.result.split(',')[1];
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('image-preview-container').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            selectedImageBase64 = null;
            document.getElementById('image-upload').value = '';
            document.getElementById('image-preview-container').classList.add('hidden');
        }

        // --- GESTI√ìN DE AGENTES ---
        async function cargarAgentes() {
            const { data } = await supabaseClient.from('agentes').select('*').order('created_at', { ascending: false });
            const list = document.getElementById('agents-list');
            list.innerHTML = '';
            data.forEach((agente, i) => {
                const div = document.createElement('div');
                div.id = `agent-${agente.id}`;
                div.className = "agent-card p-4 rounded-2xl cursor-pointer mb-2 transition-all";
                div.onclick = () => setAgent(agente);
                div.innerHTML = `<div class="font-bold text-sm text-white">‚ú® ${agente.nombre}</div><div class="text-[10px] text-white opacity-60 uppercase">${agente.descripcion || 'Conciencia'}</div>`;
                list.appendChild(div);
                if (i === 0) setAgent(agente);
            });
        }

        async function setAgent(agente) {
            currentAgent = agente;
            currentAgent.conocimiento_texto = ""; 
            if (agente.archivo_url) {
                try {
                    const res = await fetch(agente.archivo_url);
                    const blob = await res.blob();
                    const ext = agente.archivo_url.split('.').pop().toLowerCase().split('?')[0];
                    if (ext === 'txt' || ext === 'json') currentAgent.conocimiento_texto = await blob.text();
                    else if (ext === 'pdf') currentAgent.conocimiento_texto = await extractTextFromPDF(agente.archivo_url);
                    else if (ext === 'docx') {
                        const buffer = await blob.arrayBuffer();
                        const out = await mammoth.extractRawText({ arrayBuffer: buffer });
                        currentAgent.conocimiento_texto = out.value;
                    }
                } catch(e) { console.error(e); }
            }
            document.getElementById('active-agent-name').innerText = currentAgent.nombre;
            document.getElementById('active-agent-desc').innerText = currentAgent.descripcion || "Conciencia";
            document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`agent-${agente.id}`)?.classList.add('active');
            toggleSidebar('agents-sidebar', false);
            createNewChat();
        }

        async function extractTextFromPDF(url) {
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
            const pdf = await pdfjsLib.getDocument(url).promise;
            let text = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(s => s.str).join(" ") + "\n";
            }
            return text;
        }

        // --- ENV√çO CON REFUERZO VISUAL ---
        async function handleSend() {
            const text = chatInput.value.trim();
            if (!text && !selectedImageBase64) return;

            // 1. Mostrar en pantalla
            let html = text;
            if (selectedImageBase64) {
                const src = document.getElementById('image-preview').src;
                html = `<div class="flex flex-col gap-2"><img src="${src}" class="max-w-[200px] rounded-lg border-2 border-white shadow-md"><span>${text || "Analiza esta imagen."}</span></div>`;
            }

            appendBubble(html, true);
            chatInput.value = '';
            
            const typing = showTyping();
            const imgData = selectedImageBase64;
            const msgText = text;
            clearImage(); 

            try {
                // REFUERZO: Si hay imagen, inyectamos instrucci√≥n directa al sistema
                let instructions = currentAgent.instrucciones;
                if (imgData) instructions += "\n\nIMPORTANTE: El usuario te ha enviado una IMAGEN. Anal√≠zala visualmente antes de responder.";

                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        systemInstruction: `${instructions}\n\nCONTEXTO:\n${currentAgent.conocimiento_texto || ''}`, 
                        contents: chatHistory,
                        image: imgData,
                        text: msgText || "Analiza esta imagen y dime qu√© ves."
                    })
                });

                const data = await response.json();
                typing.remove();
                if (data.success) {
                    appendBubble(data.text, false);
                    await saveToHubHistory();
                } else {
                    appendBubble("El espejo no pudo ver la imagen. ¬øEst√° bien configurado el servidor?", false);
                }
            } catch (err) {
                if(typing) typing.remove();
                appendBubble("Error de conexi√≥n.", false);
            }
        }

        function appendBubble(text, isUser) {
            const div = document.createElement('div');
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'}`;
            const isH = text.includes('<div') || text.includes('<img');
            div.innerHTML = `<div class="bubble ${isUser ? 'bubble-user' : 'bubble-ai'}">${isH ? text : text.replace(/\n/g, '<br>')}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;

            // Historial: Marcamos que hubo una imagen para que la IA guarde el contexto
            let hText = text;
            if (isH) {
                const tmp = document.createElement('div');
                tmp.innerHTML = text;
                hText = `[Imagen analizada] ${tmp.innerText.trim()}`;
            }
            chatHistory.push({ role: isUser ? "user" : "model", parts: [{ text: hText }] });
        }

        // --- PERSISTENCIA ---
        async function saveToHubHistory() {
            if (!currentUser || chatHistory.length < 2) return;
            const f = chatHistory.find(m => m.role === "user")?.parts[0].text || "Reflexi√≥n";
            const t = f.substring(0, 30).replace("[Imagen analizada]", "üì∑") + "...";
            await supabaseClient.from('reflexiones_hub').upsert({
                id: currentChatId, user_id: currentUser.id, agent_id: currentAgent.id, title: t, history: chatHistory, updated_at: new Date().toISOString()
            });
            refreshHistorySidebar();
        }

        async function refreshHistorySidebar() {
            if (!currentUser) return;
            const { data } = await supabaseClient.from('reflexiones_hub').select('*').eq('user_id', currentUser.id).order('updated_at', { ascending: false });
            const list = document.getElementById('history-list');
            if (list) {
                list.innerHTML = data.map(c => `
                    <div onclick="loadChat('${c.id}')" class="history-item">
                        <div class="text-xs font-bold truncate">${c.title}</div>
                        <div class="text-[8px] opacity-60 uppercase mt-1">${new Date(c.updated_at).toLocaleDateString()}</div>
                    </div>
                `).join('');
            }
        }

        async function loadChat(id) {
            const { data } = await supabaseClient.from('reflexiones_hub').select('*').eq('id', id).single();
            if(data) {
                currentChatId = data.id; chatHistory = data.history; chatBox.innerHTML = '';
                chatHistory.forEach(m => {
                    const div = document.createElement('div');
                    div.className = `flex w-full ${m.role === 'user' ? 'justify-end' : 'justify-start'}`;
                    div.innerHTML = `<div class="bubble ${m.role === 'user' ? 'bubble-user' : 'bubble-ai'}">${m.parts[0].text.replace(/\n/g, '<br>')}</div>`;
                    chatBox.appendChild(div);
                });
                chatBox.scrollTop = chatBox.scrollHeight; toggleSidebar('history-sidebar', false);
            }
        }

        function createNewChat() {
            currentChatId = Date.now(); chatHistory = []; chatBox.innerHTML = '';
            if(currentAgent) appendBubble(`Soy ${currentAgent.nombre}. ¬øQu√© buscas reflejar hoy?`, false);
        }

        // --- UI ---
        function toggleSidebar(id, show) {
            const el = document.getElementById(id);
            const isL = id === 'history-sidebar';
            el.style.transform = show ? 'translateX(0)' : (isL ? 'translateX(-100%)' : 'translateX(100%)');
        }

        function showTyping() {
            const div = document.createElement('div');
            div.className = "text-xs opacity-50 italic p-2 dark:text-white";
            div.innerText = `${currentAgent?.nombre || 'Espejo'} analizando...`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return div;
        }

        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); }

        function createParticle() {
            const container = document.getElementById('particle-container');
            if (!container) return;
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = `${Math.random() * 100}%`;
            p.style.setProperty('--duration', `${Math.random() * 12 + 8}s`);
            container.appendChild(p);
            setTimeout(() => p.remove(), 12000);
        }

        init();
    </script>
</body>
</html>