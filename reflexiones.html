<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galería de Reflexiones | Inmersión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        body, html { margin: 0; padding: 0; background: black; overflow: hidden; }
        .swiper { width: 100%; height: 100vh; }
        .swiper-slide { position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        /* Zoom suave infinito */
        .bg-image { 
            position: absolute; inset: 0; 
            background-size: cover; 
            background-position: center; 
            filter: brightness(0.4) blur(1px); 
            transform: scale(1.1); 
            transition: transform 10s linear;
        }
        .swiper-slide-active .bg-image { transform: scale(1); }

        .content { 
            position: relative; z-index: 10; 
            max-width: 900px; text-align: center; 
            color: white; padding: 2rem; 
        }
        .quote-line { height: 2px; width: 60px; background: #f59e0b; margin: 2rem auto; }
        
        .loader { 
            position: fixed; inset: 0; background: black; z-index: 100; 
            display: flex; align-items: center; justify-content: center; 
            color: white; transition: 1s; 
        }

        .swiper-pagination-bullet { background: white !important; opacity: 0.2; }
        .swiper-pagination-bullet-active { background: #f59e0b !important; opacity: 1; }
    </style>
</head>
<body>

    <div id="loader" class="loader font-bold uppercase tracking-widest text-xs italic">
        Sincronizando con el consciente colectivo...
    </div>

    <a href="refugio.html" class="fixed top-6 left-6 md:top-10 md:left-10 z-50 text-white font-bold bg-white/10 px-6 py-3 rounded-full backdrop-blur-xl border border-white/10 text-[10px] md:text-xs uppercase tracking-widest hover:bg-amber-600 transition-all">
        ← Volver al Refugio
    </a>

    <div class="swiper mySwiper">
        <div class="swiper-wrapper" id="wrapper"></div>
        <div class="swiper-pagination"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        const SB_URL = 'https://jkhrpbpdewhkzgqqrwmp.supabase.co';
        const SB_KEY = 'sb_publishable_xj9waE1quyimP47S4gmtLg_lKs5eszo';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        const defaultImages = [
            'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=1600',
            'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=1600',
            'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=1600',
            'https://images.unsplash.com/photo-1518495973542-4542c06a5843?q=80&w=1600'
        ];

        async function initGallery() {
            const wrapper = document.getElementById('wrapper');
            
            try {
                const { data: allPosts, error } = await supabaseClient
                    .from('reflexiones')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // --- Lógica para que el ejemplo sea el primero siempre ---
                const exampleText = "A veces soltar";
                const examplePost = allPosts.find(p => p.text.includes(exampleText));
                const otherPosts = allPosts.filter(p => p.id !== examplePost?.id);
                const finalPosts = examplePost ? [examplePost, ...otherPosts] : otherPosts;

                finalPosts.forEach((post, i) => {
                    const bgImg = post.image_url ? post.image_url : defaultImages[i % defaultImages.length];
                    
                    wrapper.innerHTML += `
                    <div class="swiper-slide">
                        <div class="bg-image" style="background-image: url('${bgImg}')"></div>
                        <div class="content">
                            <p class="text-3xl md:text-5xl lg:text-6xl font-light italic leading-tight mb-6 px-4">"${post.text}"</p>
                            <div class="quote-line"></div>
                            <p class="text-[10px] md:text-xs uppercase tracking-[0.6em] font-black opacity-40">${post.author}</p>
                        </div>
                    </div>`;
                });

                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').remove(), 1000);

                // INICIALIZAR CARRUSEL (Swiper)
                new Swiper(".mySwiper", {
                    direction: 'vertical', // Carrusel vertical como pediste
                    loop: finalPosts.length > 1,
                    speed: 2000,
                    effect: 'fade',
                    fadeEffect: { crossFade: true },
                    autoplay: {
                        delay: 8000,
                        disableOnInteraction: false,
                    },
                    pagination: { el: ".swiper-pagination", clickable: true },
                    mousewheel: true,
                    keyboard: { enabled: true }
                });

            } catch (err) {
                console.error(err);
                document.getElementById('loader').innerText = "Error de conexión.";
            }
        }

        document.addEventListener('DOMContentLoaded', initGallery);
    </script>
    <script src="music-player.js"></script>
</body>
</html>