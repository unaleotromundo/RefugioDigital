<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente Digital | El Refugio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script>
        // Configuraci√≥n de Tema
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }
    </script>

    <style>
        body { background: #fffcf7; font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.5s; }
        .dark body { background: #080a0f; color: white; }
        .chat-container { height: calc(100vh - 220px); scroll-behavior: smooth; }
        .bubble { border-radius: 2rem; padding: 1.2rem 1.5rem; max-width: 85%; animation: slideUp 0.3s ease-out; line-height: 1.6; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #d9770644; border-radius: 10px; }
    </style>
</head>
<body class="overflow-hidden">
    
    <nav class="p-6 flex justify-between items-center max-w-7xl mx-auto">
        <a href="refugio.html" class="text-xs font-black uppercase tracking-[0.3em] text-amber-600 flex items-center gap-2">
            <span class="text-xl">‚Üê</span> Salir al Refugio
        </a>
        <button onclick="toggleDarkMode()" class="p-3 rounded-full bg-amber-500/10 text-amber-600 hover:bg-amber-500/20 transition-all">üåô</button>
    </nav>

    <main class="max-w-3xl mx-auto px-6">
        <!-- Contenedor del Chat -->
        <div class="chat-container overflow-y-auto p-4 space-y-6" id="chat-box">
            <div class="bubble bg-amber-500/10 self-start text-slate-700 dark:text-amber-100 italic border border-amber-500/5">
                Hola. Soy tu espejo digital. En este espacio no existen los juicios, solo la comprensi√≥n. ¬øQu√© necesitas soltar o entender hoy?
            </div>
        </div>

        <!-- √Årea de Input -->
        <div class="mt-6 relative group">
            <input type="text" 
                   id="chat-input" 
                   onkeydown="if(event.key==='Enter') send()" 
                   placeholder="Escribe tu sentir aqu√≠..." 
                   class="w-full p-6 pr-20 rounded-full bg-slate-800 dark:bg-slate-900 shadow-2xl border border-amber-500/20 focus:outline-none focus:ring-4 ring-amber-500/10 text-white placeholder:text-white/40 text-lg italic">
            
            <button onclick="send()" class="absolute right-3 top-1/2 -translate-y-1/2 bg-amber-600 text-white p-4 rounded-full hover:bg-amber-500 transition-all shadow-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
        <p class="text-center text-[10px] text-slate-400 mt-4 uppercase tracking-widest opacity-50 italic">Tu reflexi√≥n es privada en este espejo digital</p>
    </main>

    <script>
        // --- L√ìGICA DE CONEXI√ìN A GEMINI ---
        const API_KEY = "AIzaSyBLdYuJzGVqf8pnlY2-LJmshD9hqvR-QCg"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;

        async function send() {
            const input = document.getElementById('chat-input');
            const box = document.getElementById('chat-box');
            const userText = input.value.trim();

            if (!userText) return;

            // 1. Mostrar mensaje del usuario
            box.innerHTML += `
                <div class="flex flex-col items-end">
                    <div class="bubble bg-amber-600 text-white shadow-lg">
                        ${userText}
                    </div>
                </div>`;
            
            input.value = ''; // Limpiar input
            box.scrollTop = box.scrollHeight;

            // 2. Crear indicador de carga (Escribiendo...)
            const typingId = "typing-" + Date.now();
            box.innerHTML += `
                <div id="${typingId}" class="bubble bg-amber-500/10 self-start text-slate-400 italic border border-amber-500/5 animate-pulse">
                    El espejo est√° reflexionando...
                </div>`;
            box.scrollTop = box.scrollHeight;

            try {
                // 3. Llamada a la API de Gemini
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Eres un "Espejo Digital" po√©tico y emp√°tico. Escuchas al usuario en un espacio seguro llamado "El Refugio". Responde de forma breve, profunda y sin juzgar. Usuario dice: "${userText}"`
                            }]
                        }]
                    })
                });

                const data = await response.json();
                
                // Quitar indicador de carga
                const typingElement = document.getElementById(typingId);
                if (typingElement) typingElement.remove();

                // 4. Mostrar respuesta
                if (data.candidates && data.candidates[0].content) {
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    box.innerHTML += `
                        <div class="bubble bg-amber-500/10 self-start text-slate-700 dark:text-amber-100 italic border border-amber-500/5">
                            ${aiResponse.replace(/\n/g, '<br>')}
                        </div>`;
                } else {
                    // Si hay error en la respuesta de la API (ej: clave bloqueada)
                    const errorMsg = data.error ? data.error.message : "Error desconocido";
                    throw new Error(errorMsg);
                }

            } catch (error) {
                console.error("Error:", error);
                const typingElement = document.getElementById(typingId);
                if (typingElement) {
                    typingElement.innerHTML = `<span class="text-red-400">El Refugio est√° en silencio: ${error.message}</span>`;
                }
            }

            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>